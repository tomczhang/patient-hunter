# 数据库 Schema 扩展提案

## Why

当前数据库 schema 只支持基础的资产管理和笔记功能，缺少以下核心能力：
1. **历史快照**：无法查看资产历史趋势
2. **规则系统**：无法设置投资纪律和自动执行
3. **提醒系统**：无法设置价格提醒和纪律提醒
4. **内容管理**：无法管理金融教练和文档
5. **日历功能**：无法管理投资计划和提醒
6. **通知系统**：缺少统一的通知管理

## What Changes

### 新增表（8个）

1. **PortfolioSnapshot** - 仓位快照（支持全仓和单个组合）
2. **WatchedStock** - 关注的股票（带价格提醒）
3. **RuleTemplate** - 规则模板（全局预设规则）
4. **UserRule** - 用户规则实例
5. **DisciplineExecution** - 规则执行历史
6. **ContentSource** - 内容源（金融教练）
7. **ContentItem** - 内容项（文章/文档）
8. **CalendarEvent** - 日历事件（支持重复）
9. **Notification** - 通知表

### 扩展表（1个）

- **User** - 新增 `phone` 和 `primaryCurrency` 字段

## Capabilities

### New Capabilities

1. **仓位快照系统**
   - 每天 0:00 自动生成前一天的快照
   - 支持全仓快照和单个组合快照
   - 存储快照时的汇率和市值
   - 按粒度保留（日快照365天，周快照5年，月快照永久）

2. **规则系统**
   - 预设规则模板（平台提供）
   - 用户规则实例（用户配置）
   - 规则执行历史（记录执行情况）
   - 支持规则版本管理

3. **提醒系统**
   - 价格提醒（达到某个价格、涨跌幅）
   - 纪律提醒（规则执行时自动触发）
   - 多渠道通知（站内、邮件、短信、电话）

4. **内容管理**
   - 手动添加内容源（公众号、文档、RSS）
   - 文档解析（PDF/Word/TXT → 文本）
   - 向量化存储（关联 Qdrant）

5. **日历功能**
   - 支持重复事件（每天、每周、每月）
   - 支持工作日重复
   - 关联交易、组合、规则

6. **通知系统**
   - 统一的通知表
   - 记录发送渠道
   - 按类型分类

## Impact

### 数据库变更

- **新增 9 个表**
- **扩展 1 个表**（User）
- **新增 15+ 个索引**

### 定时任务

- **快照生成任务**：每天 0:00 执行
- **快照清理任务**：定期清理过期快照（可选）

### API 变更

- 新增快照查询 API
- 新增规则管理 API
- 新增提醒管理 API
- 新增内容管理 API
- 新增日历管理 API
- 新增通知查询 API

### 前端变更

- 快照趋势图表
- 规则配置界面
- 提醒设置界面
- 内容管理界面
- 日历界面
- 通知中心

## 设计亮点

1. **灵活的 JSON 存储**：使用 JSON 字段存储灵活的配置和数据
2. **版本管理**：规则模板支持版本，用户规则实例关联模板
3. **数据保留策略**：按粒度保留快照，平衡存储和查询需求
4. **多渠道通知**：统一的通知表，支持多种通知渠道
5. **工作日重复**：支持工作日重复事件，满足实际需求
